<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NORBOY - Dashboard Chatbot WhatsApp</title>
  <script src="js/pre-auth.js"></script>
  <!-- Dashboard CSS (split into 5 modules for maintainability) -->
  <link rel="stylesheet" href="css/dashboard-base.css">
  <link rel="stylesheet" href="css/quick-replies.css">
  <link rel="stylesheet" href="css/dashboard-layout.css">
  <link rel="stylesheet" href="css/dashboard-components.css">
  <link rel="stylesheet" href="css/dashboard-views.css">
  <link rel="stylesheet" href="css/dashboard-responsive.css">

  <!-- ========================================
       MODO OSCURO - CSS
       ======================================== -->
  <link rel="stylesheet" href="css/dark-mode.css">

  <!-- ========================================
       CORRECCIONES DE TEXTO - CSS
       ======================================== -->
  <link rel="stylesheet" href="css/text-truncation-fixes.css">

  <!-- ========================================
       CORRECCIONES URGENTES DE VISUALIZACI√ìN - CSS
       (Tarjetas con contraste + Chat estilo WhatsApp)
       ======================================== -->
  <link rel="stylesheet" href="css/urgent-visual-fixes.css">

  <!-- ========================================
       CHAT ESTILO WHATSAPP - CSS COMPLETO
       (Scroll + Interfaz exacta WhatsApp)
       ======================================== -->
  <link rel="stylesheet" href="css/whatsapp-chat-style.css">

  <!-- ========================================
       CHAT FIXED - CSS CORREGIDO
       (Alineaci√≥n correcta + max-width + espaciado)
       ======================================== -->
  <link rel="stylesheet" href="css/chat-fixed.css">
</head>

<body>

  <!-- ========================================
       LOGIN OVERLAY
       ======================================== -->
  <div class="login-overlay" id="login-overlay">
    <div class="login-card">
      <div class="login-logo">
        <img src="LOGO.jpeg" alt="NORBOY Logo" style="max-width: 100px; height: auto; margin-bottom: 15px;">
        <h2>NORBOY Chatbot</h2>
        <p>Inicia sesi√≥n para continuar</p>
      </div>

      <div class="login-error" id="login-error"></div>

      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="login-form-group">
          <label for="username">Usuario</label>
          <input type="text" id="username" name="username" placeholder="Ingresa tu usuario" required
            autocomplete="username">
        </div>

        <div class="login-form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" name="password" placeholder="Ingresa tu contrase√±a" required
            autocomplete="current-password">
        </div>

        <button type="submit" class="login-btn" id="login-btn">Iniciar Sesi√≥n</button>
      </form>
    </div>
  </div>

  <!-- ========================================
       ESTRUCTURA DEL DASHBOARD
       ======================================== -->
  <div class="dashboard-wrapper" id="dashboard-wrapper" style="display: none;">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <!-- Logo -->
      <div class="sidebar-logo">
        <img src="LOGO.jpeg" alt="NORBOY Logo" style="max-width: 120px; height: auto; margin-bottom: 10px;">
        <div class="sidebar-logo-text">NORBOY</div>
        <div class="sidebar-logo-subtitle">Chatbot WhatsApp</div>
      </div>

      <!-- Navigation -->
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" onclick="changeView('home'); return false;">
          <span class="nav-item-icon">üè†</span>
          <span class="nav-item-text">Inicio</span>
        </a>
        <a href="#" class="nav-item" onclick="changeView('conversations'); return false;">
          <span class="nav-item-icon">üí¨</span>
          <span class="nav-item-text">Conversaciones</span>
          <span id="pending-advisor-badge" class="pending-badge" style="display: none;">0</span>
        </a>

        <div class="nav-section-title">Herramientas</div>
        <a href="#" class="nav-item" onclick="changeView('documents'); return false;">
          <span class="nav-item-icon">üìÅ</span>
          <span class="nav-item-text">Documentos</span>
        </a>

        <a href="#" class="nav-item" onclick="changeView('number-control'); return false;">
          <span class="nav-item-icon">üî¢</span>
          <span class="nav-item-text">Control de N√∫meros</span>
        </a>
        <a href="#" class="nav-item" onclick="changeView('holidays'); return false;">
          <span class="nav-item-icon">üìÖ</span>
          <span class="nav-item-text">D√≠as Festivos</span>
        </a>
        <a href="#" class="nav-item" id="nav-quick-replies" onclick="changeView('quick-replies'); return false;">
          <span class="nav-item-icon">‚ö°</span>
          <span class="nav-item-text">Respuestas R√°pidas</span>
        </a>
        <a href="#" class="nav-item" onclick="changeView('settings'); return false;">
          <span class="nav-item-icon">‚öôÔ∏è</span>
          <span class="nav-item-text">Configuraci√≥n</span>
        </a>
      </nav>

      <!-- Footer -->
      <div class="sidebar-footer">
        v1.0.0 - Dashboard
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="main-content">

      <!-- HEADER -->
      <header class="dashboard-header">
        <div class="header-left">
          <div>
            <div class="header-title">Dashboard Chatbot</div>
            <div class="header-subtitle" id="current-view-name">Inicio</div>
          </div>
        </div>
        <div class="header-right">
          <!-- Reloj del dashboard -->
          <div class="dashboard-clock" id="dashboard-clock">
            <span class="clock-icon">üïê</span>
            <span class="clock-time" id="clock-time">00:00</span>
            <span class="clock-seconds" id="clock-seconds">:00</span>
          </div>

          <button class="header-upload-btn" id="header-upload-btn" style="display: none;" onclick="openUploadModal()">
            <span>üì§</span>
            <span>Subir documentos</span>
          </button>
          <div class="header-status-badge disconnected" id="header-status">
            <span class="status-dot"></span>
            <span id="header-status-text">Desconectado</span>
          </div>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <main class="dashboard-content">

        <!-- Breadcrumb -->
        <div class="breadcrumb">
          <span class="breadcrumb-item">
            <span>üè†</span>
            <span>Dashboard</span>
          </span>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <span class="breadcrumb-item breadcrumb-active" id="breadcrumb-active">Inicio</span>
        </div>

        <!-- Content Card - Aqu√≠ va el contenido original -->
        <div class="content-card">

          <!-- ========================================
     PARTE 2 - INICIA AQU√ç
     CONTENIDO ORIGINAL DEL CHATBOT
     ======================================== -->

          <!-- styles moved to css/dashboard.css -->

          <!-- ========================================
     PARTE 3: HTML DEL CONTENIDO ORIGINAL
     (Preservado sin modificar l√≥gica)
     ======================================== -->

          <div class="container">
            <div class="header">
              <div class="header-left">
                <img src="LOGO.jpeg" alt="NORBOY Logo" class="logo"
                  style="width: 50px; height: 50px; object-fit: contain;">
                <div class="header-title">
                  <h1>NORBOY Chatbot</h1>
                  <p>Elegimos Juntos 2026-2029</p>
                </div>
              </div>
              <button class="settings-btn" onclick="toggleTab('settings')">‚öôÔ∏è</button>
            </div>

            <div class="tabs">
              <div class="tab active" onclick="switchTab('whatsapp')">üì± WhatsApp</div>
              <div class="tab" onclick="switchTab('settings')">üîë API Keys</div>
            </div>

            <!-- WhatsApp Tab -->
            <div id="tab-whatsapp" class="tab-content active">
              <div class="status-container">
                <div id="status" class="status disconnected">
                  <span class="status-dot"></span>
                  <span id="status-text">Desconectado</span>
                </div>
              </div>

              <div id="qr-container" class="qr-container">
                <div class="spinner"></div>
                <p class="qr-placeholder">Cargando...</p>
              </div>

              <div id="instructions" class="instructions" style="display: none;">
                <h3>üì± C√≥mo conectar WhatsApp:</h3>
                <ol>
                  <li>Abre WhatsApp en tu tel√©fono</li>
                  <li>Ve a <strong>Configuraci√≥n</strong> ‚Üí <strong>Dispositivos vinculados</strong></li>
                  <li>Toca en <strong>Vincular un dispositivo</strong></li>
                  <li>Escanea el c√≥digo QR de arriba</li>
                </ol>
              </div>

              <!-- Bot√≥n para generar nuevo QR (siempre visible) -->
              <div id="new-qr-button" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="limpiarSesion()"
                  style="width: 100%; background: #ffebee; color: #c62828;">
                  üóëÔ∏è Generar Nuevo QR Code
                </button>
                <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                  ‚ö†Ô∏è Usa este bot√≥n si no aparece el QR o tienes problemas de conexi√≥n
                </p>
              </div>

              <!-- Session Management Buttons (solo cuando est√° conectado) -->
              <div id="session-buttons" style="display: none; margin-top: 20px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <button class="btn btn-secondary" onclick="cerrarSesion()" style="flex: 1; min-width: 200px;">
                    üîì Cerrar Sesi√≥n Actual
                  </button>
                  <button class="btn btn-secondary" onclick="limpiarSesion()"
                    style="flex: 1; min-width: 200px; background: #ffebee; color: #c62828;">
                    üóëÔ∏è Nuevo QR Code
                  </button>
                </div>
                <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                  ‚ö†Ô∏è Cerrar sesi√≥n desconecta el bot. Nuevo QR requiere escanear de nuevo.
                </p>
              </div>

              <div id="test-section" class="test-section">
                <h3>üß™ Probar Chatbot</h3>
                <div class="test-input">
                  <input type="text" id="test-message" placeholder="Escribe un mensaje...">
                  <button onclick="testChat()">Enviar</button>
                </div>
                <div id="chat-test" class="chat-test"></div>
              </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
              <!-- ‚úÖ NUEVO: Secci√≥n de Proveedor de IA con prioridad fija -->
              <div class="settings-section"
                style="margin-bottom: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50;">
                <h3>ü§ñ Proveedor de IA</h3>

                <div id="ai-settings-alert" style="margin-bottom: 15px;"></div>

                <p style="margin-bottom: 15px; color: #555; font-size: 0.95em;">
                  <strong>Prioridad fija:</strong> ChatGPT es siempre el primario. Grok act√∫a como respaldo si ChatGPT
                  falla.
                </p>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                  <!-- Toggle ChatGPT -->
                  <div
                    style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-size: 24px;">ü§ñ</span>
                      <div>
                        <strong style="color: #1a237e;">ChatGPT (OpenAI)</strong>
                        <div style="font-size: 0.85em; color: #666;">Proveedor primario - GPT-4</div>
                      </div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="ai-chatgpt-toggle" onchange="updateAIProviderSettings()">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>

                  <!-- Toggle Grok -->
                  <div
                    style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-size: 24px;">üöÄ</span>
                      <div>
                        <strong style="color: #ff6f00;">Grok (Groq)</strong>
                        <div style="font-size: 0.85em; color: #666;">Respaldo - Llama 3</div>
                      </div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="ai-grok-toggle" onchange="updateAIProviderSettings()">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <div id="ai-provider-status"
                  style="margin-top: 15px; padding: 10px; border-radius: 6px; background: #f5f5f5; font-size: 0.9em;">
                </div>
              </div>

              <div class="settings-section">
                <h3>‚öôÔ∏è Configuraci√≥n de API Keys</h3>

                <div id="settings-alert"></div>

                <div class="provider-select">
                  <div id="provider-groq" class="provider-option active" onclick="selectProvider('groq')">
                    <div class="icon">üöÄ</div>
                    <div class="name">Groq</div>
                    <div class="desc">R√°pido y gratuito</div>
                    <div id="groq-status" class="provider-status pending">‚è≥ No configurado</div>
                  </div>
                  <div id="provider-openai" class="provider-option" onclick="selectProvider('openai')">
                    <div class="icon">ü§ñ</div>
                    <div class="name">OpenAI</div>
                    <div class="desc">GPT-4 / GPT-3.5</div>
                    <div id="openai-status" class="provider-status pending">‚è≥ No configurado</div>
                  </div>
                </div>

                <!-- Groq Settings -->
                <div id="groq-settings">
                  <div class="form-group">
                    <label>üîë Groq API Key</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="password" id="groq-key" placeholder="gsk_..." style="flex: 1;">
                      <button onclick="deleteApiKey('groq')" title="Eliminar API Key de Groq"
                        style="padding: 10px 14px; background: #ffebee; color: #c62828; border: 2px solid #ef9a9a; border-radius: 10px; cursor: pointer; font-size: 13px; white-space: nowrap; transition: all 0.3s;">
                        üóëÔ∏è Eliminar
                      </button>
                    </div>
                    <div id="groq-key-status" style="margin-top: 5px; font-size: 12px;"></div>
                    <small>Obt√©n tu key en <a href="https://console.groq.com"
                        target="_blank">console.groq.com</a></small>
                  </div>
                  <div class="form-group">
                    <label>Modelo</label>
                    <select id="groq-model">
                      <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Recomendado)</option>
                      <option value="llama-3.1-70b-versatile">Llama 3.1 70B</option>
                      <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                      <option value="gemma2-9b-it">Gemma 2 9B</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                      <input type="checkbox" id="groq-enabled" checked
                        style="width: 18px; height: 18px; cursor: pointer;">
                      <span>‚úÖ Activar Groq</span>
                    </label>
                    <small style="margin-left: 28px; color: #666;">Desmarca para desactivar este proveedor de IA</small>
                  </div>
                </div>

                <!-- OpenAI Settings -->
                <div id="openai-settings" style="display: none;">
                  <div class="form-group">
                    <label>üîë OpenAI API Key</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="password" id="openai-key" placeholder="sk-..." style="flex: 1;">
                      <button onclick="deleteApiKey('openai')" title="Eliminar API Key de OpenAI"
                        style="padding: 10px 14px; background: #ffebee; color: #c62828; border: 2px solid #ef9a9a; border-radius: 10px; cursor: pointer; font-size: 13px; white-space: nowrap; transition: all 0.3s;">
                        üóëÔ∏è Eliminar
                      </button>
                    </div>
                    <div id="openai-key-status" style="margin-top: 5px; font-size: 12px;"></div>
                    <small>Obt√©n tu key en <a href="https://platform.openai.com/api-keys"
                        target="_blank">platform.openai.com</a></small>
                  </div>
                  <div class="form-group">
                    <label>Modelo</label>
                    <select id="openai-model">
                      <option value="gpt-4o-mini">GPT-4o Mini (Econ√≥mico)</option>
                      <option value="gpt-4o">GPT-4o (Potente)</option>
                      <option value="gpt-4-turbo">GPT-4 Turbo</option>
                      <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                      <input type="checkbox" id="openai-enabled" checked
                        style="width: 18px; height: 18px; cursor: pointer;">
                      <span>‚úÖ Activar OpenAI</span>
                    </label>
                    <small style="margin-left: 28px; color: #666;">Desmarca para desactivar este proveedor de IA</small>
                  </div>
                </div>

                <!-- ‚úÖ NUEVO: AWS/DynamoDB Settings -->
                <div id="aws-settings"
                  style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px; border: 2px solid #ff9800;">
                  <h4 style="margin: 0 0 15px 0; color: #e65100; display: flex; align-items: center; gap: 8px;">üóÑÔ∏è AWS
                    / DynamoDB</h4>
                  <p style="margin: 0 0 15px 0; font-size: 13px; color: #666;">Credenciales para la base de datos
                    DynamoDB. Necesarias para persistencia de mensajes.</p>
                  <div class="form-group">
                    <label>üîë AWS Access Key ID</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                      <input type="password" id="aws-access-key" placeholder="AKIA..." style="flex: 1;">
                      <button onclick="deleteApiKey('aws')" title="Eliminar credenciales AWS"
                        style="padding: 10px 14px; background: #ffebee; color: #c62828; border: 2px solid #ef9a9a; border-radius: 10px; cursor: pointer; font-size: 13px; white-space: nowrap; transition: all 0.3s;">
                        üóëÔ∏è Eliminar
                      </button>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>üîê AWS Secret Access Key</label>
                    <input type="password" id="aws-secret-key" placeholder="wJalr..." style="width: 100%;">
                  </div>
                  <div class="form-group">
                    <label>üåé AWS Region</label>
                    <select id="aws-region">
                      <option value="us-east-1">US East (N. Virginia)</option>
                      <option value="us-east-2">US East (Ohio)</option>
                      <option value="us-west-1">US West (N. California)</option>
                      <option value="us-west-2">US West (Oregon)</option>
                      <option value="sa-east-1">South America (S√£o Paulo)</option>
                      <option value="eu-west-1">EU (Ireland)</option>
                      <option value="eu-central-1">EU (Frankfurt)</option>
                      <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                    </select>
                  </div>
                  <div id="aws-key-status" style="margin-top: 5px; font-size: 12px;"></div>
                  <small>Configura las credenciales en <a href="https://console.aws.amazon.com/iam" target="_blank">AWS
                      IAM Console</a></small>
                </div>

                <button class="btn" onclick="saveSettings()" style="margin-top: 15px;">üíæ Guardar Configuraci√≥n</button>

                <div style="margin-top: 15px;">
                  <button class="btn btn-secondary" onclick="testConnection()">üîå Probar Conexi√≥n</button>
                </div>

                <!-- ‚úÖ NUEVO: Bot√≥n r√°pido para eliminar TODAS las keys (para subir a GitHub) -->
                <div
                  style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 10px; border: 2px solid #ff9800;">
                  <h4 style="margin: 0 0 10px 0; color: #e65100; font-size: 14px;">üöÄ Preparar para GitHub</h4>
                  <p style="margin: 0 0 12px 0; font-size: 12px; color: #666;">Elimina ambas keys de .env y
                    settings.json para subir el c√≥digo de forma segura.</p>
                  <button class="btn" onclick="deleteAllApiKeys()"
                    style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); font-size: 12px;">
                    üóëÔ∏è Eliminar TODAS las API Keys
                  </button>
                </div>
              </div>
            </div>

            <footer>
              NORBOY - Asistente Virtual WhatsApp
            </footer>
          </div>

          <!-- ========================================
     VISTA DE CONVERSACIONES
     ======================================== -->
          <div id="conversations-view" style="display: none;">

            <!-- Estad√≠sticas -->
            <div class="stats-cards" id="conversations-stats">
              <div class="stat-card">
                <div class="stat-number" id="stat-total">0</div>
                <div class="stat-label">Total</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="stat-active">0</div>
                <div class="stat-label">Activas</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="stat-expired">0</div>
                <div class="stat-label">Expiradas</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="stat-consent-accepted">0</div>
                <div class="stat-label">Aceptaron</div>
              </div>
              <!-- NUEVOS INDICADORES DE ESCALACI√ìN -->
              <div class="stat-card" style="background: linear-gradient(135deg, #fff9c4 0%, #ffecb3 100%);">
                <div class="stat-number" id="stat-pending">0</div>
                <div class="stat-label">‚ö†Ô∏è Pendientes</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);">
                <div class="stat-number" id="stat-with-advisor">0</div>
                <div class="stat-label">üë®‚Äçüíº con Asesor</div>
              </div>
            </div>

            <!-- Control de Horario -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">

              <!-- Control de Horario -->
              <div
                style="display: flex; flex-direction: column; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 5px 0; color: var(--primary-green); font-size: 1em;">‚è∞ Control de Horario
                    </h3>
                    <p id="schedule-hours-label" style="margin: 0; font-size: 0.8em; color: var(--medium-gray);">
                      Horario: Cargando...
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 0.8em;">
                      Estado: <span id="schedule-status" style="font-weight: bold;">Verificando...</span>
                    </p>
                  </div>
                </div>

                <!-- Inputs de horario L-V -->
                <div
                  style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0;">
                  <label
                    style="font-size: 0.75em; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">üìÖ Lun
                    - Vie</label>
                  <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                    <select id="sched-wd-start"
                      style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em; min-width: 80px;"></select>
                    <span style="font-size: 0.8em; color: #999;">‚Üí</span>
                    <select id="sched-wd-end"
                      style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em; min-width: 80px;"></select>
                  </div>
                </div>

                <!-- Inputs de horario S√°bado -->
                <div
                  style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 8px; border: 1px solid #e0e0e0;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <label style="font-size: 0.75em; font-weight: 600; color: #555;">üìÖ S√°bado</label>
                    <label style="font-size: 0.7em; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                      <input type="checkbox" id="sched-sat-enabled" style="width: 14px; height: 14px;">
                      <span>Habilitado</span>
                    </label>
                  </div>
                  <div id="sched-sat-times" style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                    <select id="sched-sat-start"
                      style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em; min-width: 80px;"></select>
                    <span style="font-size: 0.8em; color: #999;">‚Üí</span>
                    <select id="sched-sat-end"
                      style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8em; min-width: 80px;"></select>
                  </div>
                </div>

                <!-- Bot√≥n guardar horario -->
                <button class="upload-btn" onclick="saveScheduleConfig()"
                  style="background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); font-size: 0.8em; padding: 8px 10px; margin-bottom: 8px;">
                  üíæ Guardar Horario
                </button>

                <div style="display: flex; gap: 8px; margin-top: auto;">
                  <button class="upload-btn" id="btn-enable-schedule" onclick="toggleScheduleCheck(true)"
                    style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); font-size: 0.8em; padding: 8px 10px;">
                    ‚úÖ Activar
                  </button>
                  <button class="upload-btn" id="btn-disable-schedule" onclick="toggleScheduleCheck(false)"
                    style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); font-size: 0.8em; padding: 8px 10px;">
                    ‚ùå Desactivar
                  </button>
                </div>
              </div>
            </div>

            <!-- Bot√≥n para actualizar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2 style="color: var(--primary-green); margin: 0;">üí¨ Conversaciones Activas</h2>
              <button class="upload-btn" onclick="loadConversations()">
                üîÑ Actualizar
              </button>
            </div>

            <!-- Tabla de conversaciones -->
            <div id="conversations-loading" style="display: none; text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: 15px; color: var(--medium-gray);">Cargando conversaciones...</p>
            </div>

            <div id="conversations-content" style="display: none;">
              <!-- Contenedor scrollable para m√≥vil -->
              <div class="table-responsive">
                <table class="conversations-table">
                  <thead>
                    <tr>
                      <th style="width: 12%;">Nombre</th>
                      <th style="width: 13%;">Tel√©fono</th>
                      <th style="width: 22%;">√öltimo Mensaje</th>
                      <th style="width: 11%;">Estado</th>
                      <th style="width: 12%;">Consentimiento</th>
                      <th style="width: 11%;">Tiempo Restante</th>
                      <th style="width: 19%;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="conversations-table-body">
                    <!-- Se llena din√°micamente -->
                  </tbody>
                </table>
              </div>
            </div>

            <div id="conversations-empty" style="display: none; text-align: center; padding: 60px 20px;">
              <div style="font-size: 64px; margin-bottom: 15px;">üí¨</div>
              <h3 style="color: var(--medium-gray); margin-bottom: 10px;">No hay conversaciones activas</h3>
              <p style="color: var(--medium-gray);">Las conversaciones aparecer√°n aqu√≠ cuando los usuarios interact√∫en
                con el bot.</p>
            </div>
          </div>

          <!-- ========================================
     VISTA DE DOCUMENTOS (CON SISTEMA DE ETAPAS)
     ======================================== -->
          <div id="documents-view" style="display: none;">

            <!-- Header con t√≠tulo y botones -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <h2 style="color: var(--primary-green); margin: 0;">üìÅ Base de Conocimiento</h2>
                <p style="color: var(--medium-gray); margin: 5px 0 0 0; font-size: 0.9em;">
                  Gestiona los documentos organizados por etapas del proceso
                </p>
              </div>
              <div style="display: flex; gap: 10px;">
                <button class="upload-btn" onclick="openCreateStageModal()"
                  style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                  ‚ûï Agregar Etapa
                </button>
                <button class="upload-btn" onclick="openUploadModalFromView()">
                  üì§ Subir Documento
                </button>
              </div>
            </div>

            <!-- ‚úÖ NUEVO: PESTA√ëAS DE ETAPAS -->
            <div id="stages-tabs-container" style="margin-bottom: 20px;">
              <!-- Tabs header -->
              <div id="stages-tabs-header"
                style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
                <!-- Las pesta√±as se generar√°n din√°micamente aqu√≠ -->
              </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-cards" style="margin-bottom: 20px;">
              <div class="stat-card">
                <div class="stat-number" id="doc-stat-total">0</div>
                <div class="stat-label">Total Documentos</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                <div class="stat-number" id="doc-stat-pdf">0</div>
                <div class="stat-label">üìÑ PDF</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);">
                <div class="stat-number" id="doc-stat-txt">0</div>
                <div class="stat-label">üìù TXT</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                <div class="stat-number" id="doc-stat-chunks">0</div>
                <div class="stat-label">üß© Fragmentos</div>
              </div>
            </div>

            <!-- Loading -->
            <div id="documents-view-loading" style="display: none; text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: 15px; color: var(--medium-gray);">Cargando documentos...</p>
            </div>

            <!-- Content -->
            <div id="documents-view-content" style="display: none;">
              <!-- Tabla de documentos -->
              <div class="table-responsive">
                <table class="conversations-table">
                  <thead>
                    <tr>
                      <th style="width: 5%;">Tipo</th>
                      <th style="width: 35%;">Nombre del Archivo</th>
                      <th style="width: 15%;">Fecha de Subida</th>
                      <th style="width: 12%;">Tama√±o</th>
                      <th style="width: 10%;">Fragmentos</th>
                      <th style="width: 23%;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="documents-view-table-body">
                    <!-- Los documentos se cargar√°n aqu√≠ -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Empty state -->
            <div id="documents-view-empty" style="display: none;">
              <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 15px;">üìÅ</div>
                <h3 style="color: var(--medium-gray);">No hay documentos en esta etapa</h3>
                <p style="color: var(--medium-gray); margin-bottom: 20px;">
                  Sube archivos PDF o TXT para enriquecer la base de conocimiento del chatbot
                </p>
                <button class="upload-btn" onclick="openUploadModalFromView()">
                  üì§ Subir Primer Documento
                </button>
              </div>
            </div>
          </div>

          <!-- ========================================
     ‚úÖ NUEVO: MODAL PARA CREAR/EDITAR ETAPA
     ======================================== -->
          <div class="modal-overlay" id="stage-modal">
            <div class="modal-container" style="max-width: 500px;">
              <div class="modal-header">
                <h3 class="modal-title" id="stage-modal-title">‚ûï Nueva Etapa</h3>
                <button class="modal-close" onclick="closeStageModal()">&times;</button>
              </div>

              <div style="padding: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--primary-green);">
                  Nombre de la Etapa:
                </label>
                <input type="text" id="stage-name-input" placeholder="Ej: Validaci√≥n Inicial" style="
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
      ">
                <input type="hidden" id="stage-id-input">

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="upload-btn" onclick="saveStage()"
                    style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                    ‚úÖ Guardar
                  </button>
                  <button class="upload-btn" onclick="closeStageModal()"
                    style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #c62828 100%);">
                    ‚ùå Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ========================================
     VISTA DE CONTROL DE N√öMEROS
     ======================================== -->
          <div id="number-control-view" style="display: none;">

            <!-- Header con t√≠tulo -->
            <div style="margin-bottom: 20px;">
              <h2 style="color: var(--primary-green); margin: 0;">üî¢ Control de N√∫meros</h2>
              <p style="color: var(--medium-gray); margin: 5px 0 0 0; font-size: 0.9em;">
                Gestiona los n√∫meros a los que la IA NO debe responder autom√°ticamente
              </p>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-cards" style="margin-bottom: 20px;">
              <div class="stat-card">
                <div class="stat-number" id="nc-stat-total-conversations">0</div>
                <div class="stat-label">Total Conversaciones</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);">
                <div class="stat-number" id="nc-stat-ia-inactive">0</div>
                <div class="stat-label">üî¥ IA Desactivada</div>
              </div>
              <div class="stat-card" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                <div class="stat-number" id="nc-stat-ia-active">0</div>
                <div class="stat-label">üü¢ IA Activa</div>
              </div>
            </div>

            <!-- Informaci√≥n importante -->
            <div
              style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0;">
              <strong>‚ö†Ô∏è Importante:</strong>
              <ul style="margin: 10px 0 0 0; padding-left: 20px; color: var(--dark-gray);">
                <li>Los n√∫meros con IA desactivada <strong>pueden seguir escribiendo</strong> mensajes.</li>
                <li>Solo se desactiva la <strong>respuesta autom√°tica de la IA</strong>.</li>
                <li>Los asesores pueden ver y responder manualmente desde "Conversaciones".</li>
              </ul>
            </div>

            <!-- TABS de navegaci√≥n -->
            <div class="tabs" id="nc-tabs"
              style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
              <div style="display: flex; gap: 5px;">
                <button class="tab active" onclick="switchNCTab('all')" id="nc-tab-all">
                  üìã Todos los N√∫meros
                </button>
                <button class="tab" onclick="switchNCTab('disabled')" id="nc-tab-disabled">
                  üî¥ IA Desactivada
                </button>
                <button class="tab" onclick="switchNCTab('spam')" id="nc-tab-spam">
                  üö´ Spam (<span id="nc-spam-count">0</span>)
                </button>
              </div>
              <!-- ‚úÖ NUEVO: Bot√≥n para agregar n√∫mero manualmente -->
              <button class="upload-btn" onclick="openAddNumberModal()" style="padding: 8px 16px; font-size: 13px;">
                ‚ûï Agregar N√∫mero
              </button>
            </div>

            <!-- Loading -->
            <div id="number-control-loading" style="display: none; text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <p style="margin-top: 15px; color: var(--medium-gray);">Cargando n√∫meros...</p>
            </div>

            <!-- ========================================
       TAB 1: TODOS LOS N√öMEROS
       ======================================== -->
            <div id="nc-tab-content-all" class="tab-content" style="display: block;">
              <div id="nc-all-content" style="display: none;">
                <div class="table-responsive">
                  <table class="conversations-table">
                    <thead>
                      <tr>
                        <th style="width: 18%;">Nombre</th>
                        <th style="width: 18%;">Tel√©fono</th>
                        <th style="width: 25%;">√öltima Interacci√≥n</th>
                        <th style="width: 15%;">Estado IA</th>
                        <th style="width: 24%;">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody id="nc-all-table-body">
                      <!-- Se llena din√°micamente -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="nc-all-empty" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 15px;">üì±</div>
                <h3 style="color: var(--medium-gray); margin-bottom: 10px;">No hay conversaciones a√∫n</h3>
                <p style="color: var(--medium-gray);">Los n√∫meros aparecer√°n aqu√≠ cuando interact√∫en con el chatbot.</p>
              </div>
            </div>

            <!-- ========================================
       TAB 2: IA DESACTIVADA
       ======================================== -->
            <div id="nc-tab-content-disabled" class="tab-content" style="display: none;">
              <div id="nc-disabled-content" style="display: none;">
                <div class="table-responsive">
                  <table class="conversations-table">
                    <thead>
                      <tr>
                        <th style="width: 20%;">Nombre</th>
                        <th style="width: 18%;">Tel√©fono</th>
                        <th style="width: 22%;">Fecha Desactivaci√≥n</th>
                        <th style="width: 25%;">Motivo</th>
                        <th style="width: 15%;">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody id="nc-disabled-table-body">
                      <!-- Se llena din√°micamente -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="nc-disabled-empty" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 15px;">‚úÖ</div>
                <h3 style="color: var(--medium-gray); margin-bottom: 10px;">No hay n√∫meros con IA desactivada</h3>
                <p style="color: var(--medium-gray);">Todos los n√∫meros tienen la IA activa.</p>
              </div>
            </div>

            <!-- ========================================
       TAB 3: BLOQUEADOS POR SPAM
       ======================================== -->
            <div id="nc-tab-content-spam" class="tab-content" style="display: none;">

              <!-- Informaci√≥n sobre el sistema anti-spam -->
              <div
                style="background: #fce4ec; border-left: 4px solid #e53935; padding: 15px; margin-bottom: 20px; border-radius: 0 8px 8px 0;">
                <strong>üö´ Sistema Anti-Spam:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 20px; color: var(--dark-gray); font-size: 0.9em;">
                  <li>Detecta mensajes repetidos consecutivos (similaridad > 90%).</li>
                  <li>Despu√©s de <strong>3 repeticiones</strong>: advertencia interna.</li>
                  <li>Despu√©s de <strong>4 repeticiones</strong>: la IA se desactiva autom√°ticamente.</li>
                  <li><strong>0 tokens consumidos</strong> en loops de spam.</li>
                  <li>El admin puede reactivar la IA manualmente desde aqu√≠.</li>
                </ul>
              </div>

              <!-- Estad√≠sticas de spam -->
              <div class="stats-cards" style="margin-bottom: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);">
                  <div class="stat-number" id="nc-spam-active-blocks">0</div>
                  <div class="stat-label">üö´ Bloqueados Activos</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="nc-spam-total-blocked-msgs">0</div>
                  <div class="stat-label">üìä Mensajes Bloqueados</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                  <div class="stat-number" id="nc-spam-historical">0</div>
                  <div class="stat-label">üìú Hist√≥rico Total</div>
                </div>
              </div>

              <div id="nc-spam-content" style="display: none;">
                <div class="table-responsive">
                  <table class="conversations-table">
                    <thead>
                      <tr>
                        <th style="width: 15%;">Nombre</th>
                        <th style="width: 15%;">Tel√©fono</th>
                        <th style="width: 18%;">Fecha Bloqueo</th>
                        <th style="width: 22%;">Motivo</th>
                        <th style="width: 12%;">Estado</th>
                        <th style="width: 18%;">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody id="nc-spam-table-body">
                      <!-- Se llena din√°micamente -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="nc-spam-empty" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; margin-bottom: 15px;">‚úÖ</div>
                <h3 style="color: var(--medium-gray); margin-bottom: 10px;">No hay bloqueos por spam</h3>
                <p style="color: var(--medium-gray);">El sistema anti-spam no ha detectado actividad repetitiva.</p>
              </div>
            </div>
          </div>

          <!-- Modal para agregar motivo al desactivar IA -->
          <div class="modal-overlay" id="disable-ia-modal">
            <div class="modal-container" style="max-width: 450px;">
              <div class="modal-header">
                <h3 class="modal-title">üî¥ Desactivar IA</h3>
                <button class="modal-close" onclick="closeDisableIAModal()">&times;</button>
              </div>

              <div style="padding: 10px 0;">
                <p style="color: var(--medium-gray); margin-bottom: 15px; font-size: 0.9em;">
                  La IA dejar√° de responder autom√°ticamente a este n√∫mero.
                </p>

                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                  <strong>N√∫mero:</strong> <span id="disable-ia-phone" style="font-family: monospace;"></span>
                </div>

                <div class="login-form-group">
                  <label>üìù Motivo (opcional)</label>
                  <textarea id="disable-ia-reason" rows="3" placeholder="Ej: Cliente VIP, Requiere atenci√≥n especial..."
                    style="width: 100%; padding: 12px 15px; border: 2px solid var(--border-gray); border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="upload-btn" onclick="closeDisableIAModal()"
                    style="background: var(--medium-gray); flex: 1;">
                    Cancelar
                  </button>
                  <button class="upload-btn" onclick="confirmDisableIA()"
                    style="background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); flex: 1;">
                    üî¥ Desactivar IA
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ‚úÖ NUEVO: Modal para agregar n√∫mero manualmente -->
          <div class="modal-overlay" id="add-number-modal">
            <div class="modal-container" style="max-width: 480px;">
              <div class="modal-header">
                <h3 class="modal-title">‚ûï Agregar N√∫mero Manualmente</h3>
                <button class="modal-close" onclick="closeAddNumberModal()">&times;</button>
              </div>

              <div style="padding: 10px 0;">
                <p style="color: var(--medium-gray); margin-bottom: 15px; font-size: 0.9em;">
                  Agrega un n√∫mero para desactivar la IA. El n√∫mero quedar√° registrado sin necesidad de que haya escrito
                  primero.
                </p>

                <div class="login-form-group" style="margin-bottom: 15px;">
                  <label>üì± Tel√©fono <span style="color: #c62828;">*</span></label>
                  <input type="text" id="add-number-phone" placeholder="Ej: 3001234567 (sin c√≥digo de pa√≠s)"
                    style="width: 100%; padding: 12px 15px; border: 2px solid var(--border-gray); border-radius: 10px; font-size: 14px; font-family: monospace;">
                  <small style="color: var(--medium-gray); font-size: 11px;">Solo n√∫meros, sin espacios ni
                    guiones</small>
                </div>

                <div class="login-form-group" style="margin-bottom: 15px;">
                  <label>üë§ Nombre (opcional)</label>
                  <input type="text" id="add-number-name" placeholder="Ej: Juan P√©rez"
                    style="width: 100%; padding: 12px 15px; border: 2px solid var(--border-gray); border-radius: 10px; font-size: 14px;">
                </div>

                <div class="login-form-group">
                  <label>üìù Motivo (opcional)</label>
                  <textarea id="add-number-reason" rows="2" placeholder="Ej: Cliente VIP, Requiere atenci√≥n especial..."
                    style="width: 100%; padding: 12px 15px; border: 2px solid var(--border-gray); border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div id="add-number-error"
                  style="display: none; color: #c62828; font-size: 13px; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px;">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="upload-btn" onclick="closeAddNumberModal()"
                    style="background: var(--medium-gray); flex: 1;">
                    Cancelar
                  </button>
                  <button class="upload-btn" onclick="confirmAddNumber()" style="flex: 1;" id="add-number-btn">
                    ‚ûï Agregar y Desactivar IA
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ========================================
     FIN DE LA PARTE 3
     CONTIN√öA EN LA PARTE 4 (JAVASCRIPT)...
     ======================================== -->

        </div>
        <!-- Fin del content-card -->

        <!-- ========================================
         D√çAS FESTIVOS VIEW
         ======================================== -->
        <div id="holidays-view" style="display: none;">
          <div class="view-header">
            <h2 style="font-size: 24px; margin-bottom: 8px;">üìÖ D√≠as Festivos</h2>
            <p style="color: #666;">Click en d√≠a para toggle festivo | Rojo = activo</p>
          </div>

          <!-- Control de D√≠as Festivos (toggle activar/desactivar) -->
          <div style="margin-top: 16px; margin-bottom: 16px;">
            <div
              style="display: flex; flex-direction: column; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <h3 style="margin: 0 0 5px 0; color: #e65100; font-size: 1em;">üéâ Control de Festivos</h3>
                  <p style="margin: 0; font-size: 0.8em; color: var(--medium-gray);">
                    Verifica d√≠as festivos
                  </p>
                  <p style="margin: 5px 0 0 0; font-size: 0.8em;">
                    Estado: <span id="holiday-status" style="font-weight: bold;">Verificando...</span>
                  </p>
                </div>
              </div>
              <div style="display: flex; gap: 8px; margin-top: auto;">
                <button class="upload-btn" id="btn-enable-holiday" onclick="toggleHolidayCheck(true)"
                  style="flex: 1; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); font-size: 0.8em; padding: 8px 10px; color: white;">
                  ‚úÖ Activar
                </button>
                <button class="upload-btn" id="btn-disable-holiday" onclick="toggleHolidayCheck(false)"
                  style="flex: 1; background: linear-gradient(135deg, #9e9e9e 0%, #616161 100%); font-size: 0.8em; padding: 8px 10px;">
                  ‚ùå Desactivar
                </button>
              </div>
            </div>
          </div>

          <!-- Control de Horario (dentro de d√≠as festivos) -->
          <div style="margin-bottom: 16px;">
            <div
              style="display: flex; flex-direction: column; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #1565c0;">
              <div style="margin-bottom: 10px;">
                <h3 style="margin: 0 0 8px 0; color: #1565c0; font-size: 1em;">‚è∞ Control de Horario</h3>
                <p style="margin: 3px 0; font-size: 0.8em;">
                  Estado: <span id="holiday-schedule-status" style="font-weight: bold;">Verificando...</span>
                </p>
                <div id="holiday-schedule-details" style="margin-top: 8px; font-size: 0.8em; color: #444;">
                  <p style="margin: 2px 0;">üìÖ <strong>L-V:</strong> <span id="hol-sched-weekdays">Cargando...</span>
                  </p>
                  <p style="margin: 2px 0;">üìÖ <strong>S√°b:</strong> <span id="hol-sched-saturday">Cargando...</span>
                  </p>
                  <p style="margin: 2px 0;">üìÖ <strong>Dom:</strong> <span id="hol-sched-sunday">Cargando...</span></p>
                </div>
              </div>
              <div style="display: flex; gap: 8px; margin-top: auto;">
                <button class="upload-btn" id="btn-enable-schedule-holiday" onclick="toggleScheduleCheck(true)"
                  style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); font-size: 0.8em; padding: 8px 10px;">
                  ‚úÖ Activar Horario
                </button>
                <button class="upload-btn" id="btn-disable-schedule-holiday" onclick="toggleScheduleCheck(false)"
                  style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); font-size: 0.8em; padding: 8px 10px;">
                  ‚ùå Desactivar Horario
                </button>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 24px;">
            <!-- Calendario completo con selector de a√±o -->
            <div class="card"
              style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">

              <!-- Controles: A√±o y Mes -->
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button onclick="changeYear(-1)"
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: bold;">¬´</button>
                  <select id="year-select" onchange="selectYear(this.value)"
                    style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                  </select>
                  <button onclick="changeYear(1)"
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: bold;">¬ª</button>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button onclick="changeMonth(-1)"
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">‚óÄ</button>
                  <span id="current-month-year"
                    style="padding: 8px 16px; font-weight: 600; min-width: 150px; text-align: center;"></span>
                  <button onclick="changeMonth(1)"
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">‚ñ∂</button>
                </div>
              </div>

              <!-- Grid de calendario: 12 meses -->
              <div id="year-calendar-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                <!-- Los 12 meses se generar√°n aqu√≠ -->
              </div>

              <!-- Leyenda -->
              <div style="margin-top: 20px; display: flex; gap: 20px; font-size: 12px; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 6px; cursor: pointer;"
                  onclick="toggleAllHolidays()">
                  <div style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 4px;"></div>
                  <span>üéâ Festivo (click para toggle)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <div
                    style="width: 20px; height: 20px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
                  </div>
                  <span>D√≠a normal</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- ========================================
           ‚ö° VISTA: RESPUESTAS R√ÅPIDAS (CRUD)
           ======================================== -->
      <div id="quick-replies-view" style="display: none;">

        <!-- Header -->
        <div class="qr-view-header">
          <div>
            <h2>‚ö° Respuestas R√°pidas</h2>
            <p>Escribe <strong>/</strong> en el chat para insertar una respuesta r√°pida</p>
          </div>
          <button class="upload-btn" onclick="openQRModal()" style="padding: 10px 20px;">
            ‚ûï Nueva Respuesta
          </button>
        </div>

        <!-- Info banner -->
        <div class="qr-info-banner">
          üí° Escribe <code>/</code> seguido del t√≠tulo para filtrar. Al seleccionar, el texto se inserta en el input del
          chat sin enviarlo. El asesor puede editarlo antes de enviar.
        </div>

        <!-- Contador -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <span style="color: #777; font-size: 13px;" id="qr-count">0 respuestas</span>
        </div>

        <!-- Loading -->
        <div id="qr-loading" style="display:none;">
          <div class="loading-spinner"></div>
          <p style="text-align:center; color:#aaa; margin-top:10px;">Cargando respuestas...</p>
        </div>

        <!-- Tabla -->
        <div id="qr-table-wrapper" class="qr-table-wrapper" style="display:none;">
          <table class="qr-table">
            <thead>
              <tr>
                <th style="width: 18%;">T√≠tulo</th>
                <th style="width: 40%;">Contenido (preview)</th>
                <th style="width: 10%; text-align:center;">Activa</th>
                <th style="width: 14%;">Actualizado</th>
                <th style="width: 18%;">Acciones</th>
              </tr>
            </thead>
            <tbody id="qr-table-body">
              <!-- Se llena din√°micamente -->
            </tbody>
          </table>
        </div>

        <!-- Empty state -->
        <div id="qr-empty" class="qr-empty-state" style="display:none;">
          <div class="qr-empty-icon">‚ö°</div>
          <h3>No hay respuestas r√°pidas</h3>
          <p>Crea tu primera respuesta para usarla con <code>/</code> en el chat</p>
          <button class="upload-btn" onclick="openQRModal()">‚ûï Crear primera respuesta</button>
        </div>

      </div>
      <!-- Fin quick-replies-view -->
      <!-- Fin del dashboard-content -->

    </div>
    <!-- Fin del main-content -->

    <!-- ========================================
         ‚ö° QUICK REPLIES ‚Äî MODAL CREAR / EDITAR
         ======================================== -->
    <div class="modal-overlay" id="qr-modal">
      <div class="modal-container" style="max-width: 540px;">
        <div class="modal-header">
          <h3 class="modal-title" id="qr-modal-title">‚ûï Nueva Respuesta R√°pida</h3>
          <button class="modal-close" onclick="closeQRModal()">&times;</button>
        </div>

        <div style="padding: 20px;">
          <div class="qr-form-group">
            <label for="qr-form-title">T√≠tulo (usado para filtrar con /)</label>
            <input type="text" id="qr-form-title" class="qr-form-input" placeholder="Ej: Horario, Precio, Saludo..."
              maxlength="80" onkeydown="if(event.key==='Enter') document.getElementById('qr-form-content').focus()">
          </div>

          <div class="qr-form-group">
            <label for="qr-form-content">Contenido (texto que se insertar√° en el chat)</label>
            <textarea id="qr-form-content" class="qr-form-input" rows="4"
              placeholder="Ej: ¬°Hola! Nuestro horario es de 8am a 6pm, de lunes a s√°bado. ¬øEn qu√© m√°s puedo ayudarte?"></textarea>
          </div>

          <div class="qr-form-active">
            <label class="qr-toggle" style="margin:0;">
              <input type="checkbox" id="qr-form-active" checked>
              <span class="qr-toggle-slider"></span>
            </label>
            <label for="qr-form-active" style="cursor:pointer; font-size:13px; color:#444;">
              Respuesta activa (visible en el dropdown del chat)
            </label>
          </div>

          <div class="qr-form-error" id="qr-form-error"></div>

          <div class="qr-form-actions">
            <button id="qr-form-save-btn" class="upload-btn" onclick="saveQRForm()">‚úÖ Guardar</button>
            <button class="modal-close-btn" onclick="closeQRModal()" style="
              background: none; border: 2px solid #e0e0e0; color: #666;
              padding: 10px 20px; border-radius: 8px; cursor: pointer;
              font-size: 14px; font-weight: 500;">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================================
         DOCUMENTS UPLOAD MODAL
         ======================================== -->
    <div class="modal-overlay" id="upload-modal">

      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">üì§ Subir Documentos</h3>
          <button class="modal-close" onclick="closeUploadModal()">&times;</button>
        </div>

        <div class="upload-area" id="upload-area">
          <div class="upload-icon">üìÅ</div>
          <p class="upload-text">Arrastra archivos aqu√≠ o haz clic para seleccionar</p>
          <p class="upload-hint">Archivos admitidos: PDF, TXT (m√°x. 10MB)</p>
          <button class="upload-btn" onclick="document.getElementById('file-input').click()">Seleccionar
            Archivos</button>
          <input type="file" id="file-input" class="upload-input" accept=".pdf,.txt" multiple
            onchange="handleFileSelect(event)">
        </div>

        <div id="upload-progress" style="display: none;"></div>
      </div>
    </div>

    <!-- ========================================
         DOCUMENTS LIST MODAL
         ======================================== -->
    <div class="modal-overlay" id="documents-modal">
      <div class="modal-container" style="max-width: 800px;">
        <div class="modal-header">
          <h3 class="modal-title">üìÅ Base de Conocimiento</h3>
          <button class="modal-close" onclick="closeDocumentsModal()">&times;</button>
        </div>

        <div id="documents-loading" style="display: none;">
          <div class="loading-spinner"></div>
        </div>

        <div id="documents-content">
          <div class="documents-list-header">
            <div class="documents-list-title">Documentos Cargados</div>
            <div class="documents-count" id="documents-count">0 documentos</div>
          </div>

          <div id="documents-list-container" class="documents-list">
            <!-- Documents will be loaded here -->
          </div>
        </div>

        <div style="margin-top: 20px; text-align: right;">
          <button class="upload-btn" onclick="openUploadModalFromList()">üì§ Subir Nuevo Documento</button>
        </div>
      </div>
    </div>



  </div>
  <!-- Fin del dashboard-wrapper -->

  <!-- ========================================
       LOGOUT BUTTON IN SIDEBAR
       ======================================== -->
  <!-- sidebar logout moved to js/dashboard-core.js -->

  <!-- ========================================
       PARTE 4 FINAL: JAVASCRIPT
       ======================================== -->

  <script src="/socket.io/socket.io.js"></script>

  <!-- ========================================
       MODO OSCURO - JAVASCRIPT
       ======================================== -->
  <script src="js/dark-mode-toggle.js"></script>

  <!-- Dashboard JS (split into 7 modules for maintainability) -->
  <script src="js/dashboard-auth.js"></script>
  <script src="js/dashboard-core.js"></script>
  <script src="js/dashboard-realtime.js"></script>
  <script src="js/dashboard-settings.js"></script>
  <script src="js/dashboard-conversations.js"></script>
  <script src="js/dashboard-documents.js"></script>
  <script src="js/dashboard-views.js"></script>
  <script src="js/dashboard-chat.js"></script>
  <script src="js/quick-replies.js"></script>

  <!-- ========================================
     CHAT COMPLETE - JAVASCRIPT FUNCIONAL
     (Debe cargarse DESPU√âS del script principal)
     ======================================== -->
  <script src="js/chat-complete.js?v=3"></script>

  <!-- ========================================
     CHAT MODAL - ESTILO WHATSAPP (CON EVENTOS)
     ======================================== -->
  <div class="chat-modal" id="chat-modal">
    <div class="chat-modal-content">

      <!-- HEADER - Foto de contacto + Nombre + Botones -->
      <div class="chat-modal-header">
        <div class="chat-header-contact">
          <div class="chat-header-avatar" id="chat-avatar">
            <span id="chat-avatar-initials">üë§</span>
          </div>
          <div class="chat-header-info">
            <div class="chat-header-name" id="chat-contact-name">Contacto</div>
            <div class="chat-header-status" id="chat-phone-number">+57 300 123 4567</div>
          </div>
        </div>
        <div class="chat-header-actions">
          <div class="bot-status-indicator" id="chat-bot-status">
            <span class="bot-status-dot"></span>
            <span id="chat-bot-status-text">Bot Activo</span>
          </div>
          <button class="chat-header-btn" title="Llamada" id="chat-call-btn">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
            </svg>
          </button>
          <button class="chat-modal-close" id="chat-close-btn" title="Cerrar">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
      </div>

      <!-- BODY - √Årea de mensajes con SCROLL -->
      <div class="chat-modal-body" id="chat-messages">
        <div class="chat-loading-messages">
          <div class="chat-loading-spinner"></div>
          <div>Cargando mensajes...</div>
        </div>
      </div>

      <!-- Acciones del chat (Reactivar Bot, etc) -->
      <div class="chat-actions" id="chat-actions">
        <button class="chat-action-btn reactivate" id="chat-reactivate-btn" style="display: none;">
          üîÑ Reactivar Bot
        </button>
      </div>

      <!-- FOOTER - √Årea de escritura con botones -->
      <div class="chat-modal-footer">
        <div class="chat-input-container">
          <!-- Bot√≥n emoji -->
          <button class="chat-footer-btn emoji-picker-btn" id="emoji-picker-btn" title="Emoji">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M8 14s1.5 2 4 2 4-2 4-2" />
              <line x1="9" y1="9" x2="9.01" y2="9" />
              <line x1="15" y1="9" x2="15.01" y2="9" />
            </svg>
          </button>

          <!-- Input de mensaje -->
          <textarea class="chat-message-input" id="chat-message-input" placeholder="Escribe un mensaje..."
            rows="1"></textarea>

          <!-- Bot√≥n adjuntar (clip) -->
          <button class="chat-footer-btn chat-attach-btn" id="chat-attach-btn" title="Adjuntar">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <path
                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />
            </svg>
          </button>

          <!-- Bot√≥n micr√≥fono para audio -->
          <button class="chat-footer-btn chat-audio-btn" id="chat-audio-btn" title="Grabar audio">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
              <line x1="12" y1="19" x2="12" y2="23" />
              <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
          </button>

          <!-- Bot√≥n enviar -->
          <button class="chat-send-btn" id="chat-send-btn" title="Enviar">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13" />
              <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
          </button>

          <!-- Men√∫ de adjuntar archivos -->
          <div class="attach-menu" id="attach-menu">
            <div class="attach-menu-item" data-action="image">
              <span class="attach-menu-icon">üñºÔ∏è</span>
              <span>Imagen</span>
            </div>
            <div class="attach-menu-item" data-action="document">
              <span class="attach-menu-icon">üìÑ</span>
              <span>Documento</span>
            </div>
            <div class="attach-menu-item" data-action="audio">
              <span class="attach-menu-icon">üéµ</span>
              <span>Audio</span>
            </div>
            <div class="attach-menu-item" data-action="video">
              <span class="attach-menu-icon">üé¨</span>
              <span>Video</span>
            </div>
            <div class="attach-menu-item" data-action="camera">
              <span class="attach-menu-icon">üì∑</span>
              <span>C√°mara</span>
            </div>
          </div>

          <!-- Inputs ocultos para subir archivos - WRAPPED TO PREVENT GHOST BUTTONS -->
          <div
            style="display: none !important; height: 0; width: 0; overflow: hidden; visibility: hidden; opacity: 0; pointer-events: none;">
            <input type="file" id="file-image-input" accept="image/jpeg,image/png,image/gif,image/webp">
            <input type="file" id="file-document-input"
              accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/plain">
            <input type="file" id="file-audio-input" accept="audio/mpeg,audio/ogg,audio/wav,audio/mp4,audio/webm">
            <input type="file" id="file-video-input" accept="video/mp4,video/webm,video/3gpp,video/quicktime">
            <input type="file" id="file-camera-input" accept="image/*" capture="environment">
          </div>

          <!-- Emoji Picker Panel -->
          <div class="emoji-picker-panel" id="emoji-picker-panel">
            <div class="emoji-picker-section">
              <div class="emoji-picker-section-title">Sonrisas</div>
              <div class="emoji-picker-grid">
                <span class="emoji-picker-item">üòÄ</span>
                <span class="emoji-picker-item">üòÉ</span>
                <span class="emoji-picker-item">üòÑ</span>
                <span class="emoji-picker-item">üòÅ</span>
                <span class="emoji-picker-item">üòÜ</span>
                <span class="emoji-picker-item">üòÇ</span>
                <span class="emoji-picker-item">ü§£</span>
                <span class="emoji-picker-item">üòä</span>
                <span class="emoji-picker-item">üòâ</span>
                <span class="emoji-picker-item">üòç</span>
                <span class="emoji-picker-item">üòò</span>
                <span class="emoji-picker-item">üòé</span>
                <span class="emoji-picker-item">ü§î</span>
                <span class="emoji-picker-item">üò¢</span>
                <span class="emoji-picker-item">üò°</span>
                <span class="emoji-picker-item">üò±</span>
              </div>
            </div>
            <div class="emoji-picker-section">
              <div class="emoji-picker-section-title">Gestos</div>
              <div class="emoji-picker-grid">
                <span class="emoji-picker-item">üôå</span>
                <span class="emoji-picker-item">üëè</span>
                <span class="emoji-picker-item">üëç</span>
                <span class="emoji-picker-item">üëé</span>
                <span class="emoji-picker-item">üëã</span>
                <span class="emoji-picker-item">ü§ù</span>
                <span class="emoji-picker-item">‚úåÔ∏è</span>
                <span class="emoji-picker-item">üëå</span>
              </div>
            </div>
            <div class="emoji-picker-section">
              <div class="emoji-picker-section-title">Corazones</div>
              <div class="emoji-picker-grid">
                <span class="emoji-picker-item">‚ù§Ô∏è</span>
                <span class="emoji-picker-item">üß°</span>
                <span class="emoji-picker-item">üíõ</span>
                <span class="emoji-picker-item">üíö</span>
                <span class="emoji-picker-item">üíô</span>
                <span class="emoji-picker-item">üíú</span>
                <span class="emoji-picker-item">üñ§</span>
                <span class="emoji-picker-item">üíî</span>
              </div>
            </div>
            <div class="emoji-picker-section">
              <div class="emoji-picker-section-title">√ötiles</div>
              <div class="emoji-picker-grid">
                <span class="emoji-picker-item">üéâ</span>
                <span class="emoji-picker-item">üöÄ</span>
                <span class="emoji-picker-item">‚ú®</span>
                <span class="emoji-picker-item">üìû</span>
                <span class="emoji-picker-item">üì≤</span>
                <span class="emoji-picker-item">‚úÖ</span>
                <span class="emoji-picker-item">‚ùå</span>
                <span class="emoji-picker-item">‚≠ê</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================
     ELEMENTOS RESPONSIVE PARA M√ìVIL
     ======================================== -->

  <!-- Bot√≥n de men√∫ hamburguesa para m√≥vil -->
  <button class="mobile-menu-btn" id="mobile-menu-btn" style="display: none;">
    ‚ò∞
  </button>

  <!-- Overlay oscuro cuando el sidebar est√° abierto en m√≥vil -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- ========================================
     JAVASCRIPT - FUNCIONES DEL MEN√ö M√ìVIL
     ======================================== -->
  <script src="js/dashboard-mobile.js"></script>

</body>

</html>

<!-- ========================================
     FIN DEL DASHBOARD COMPLETO

     RESUMEN DE LAS 4 PARTES:
     
     PARTE 1: Estructura base del dashboard
              - Reset CSS y variables
              - Layout con sidebar y header
              - Estilos del dashboard
              
     PARTE 2: Estilos del contenido original
              - Todos los estilos del chatbot
              - Preservados sin modificar
              
     PARTE 3: HTML del contenido original
              - Estructura del chatbot
              - Tabs y formularios
              - Preservado sin modificar
              
     PARTE 4: JavaScript completo
              - Funciones del dashboard
              - Funciones originales del chatbot
              - Socket.io y todas las integraciones
              
     ======================================== -->